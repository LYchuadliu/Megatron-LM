name: Docker Build and Push

on:
  push:
    branches:
      - main

env:
  IMAGE_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  REPO_NAME: ${{ github.repository }}  # e.g. user/project
  IMAGE_NAME: pytorch113-cu118          # your custom image name

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------------------------------
    # 1. Checkout repository
    # ----------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Login to Docker registry
    # ----------------------------------------------------
    - name: Login to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ----------------------------------------------------
    # 3. Build (same-name) image: registry/user/project:latest
    # ----------------------------------------------------
    - name: Build same-name image
      run: |
        docker build -t ${IMAGE_REGISTRY}/${REPO_NAME}:latest .

    - name: Push same-name image
      run: |
        docker push ${IMAGE_REGISTRY}/${REPO_NAME}:latest

    # ----------------------------------------------------
    # 4. Build custom image: registry/user/project/pytorch113-cu118:latest
    # ----------------------------------------------------
    - name: Build custom image
      run: |
        docker build \
          -t ${IMAGE_REGISTRY}/${REPO_NAME}/${IMAGE_NAME}:latest .

    - name: Push custom image
      run: |
        docker push ${IMAGE_REGISTRY}/${REPO_NAME}/${IMAGE_NAME}:latest
